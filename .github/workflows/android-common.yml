name: Android Common Setup

on:
  workflow_call:
    inputs:
      gradle-task:
        description: Gradle task(s) to execute.
        required: true
        type: string
      gradle-args:
        description: Additional Gradle arguments.
        required: false
        type: string
        default: '--stacktrace --warning-mode all'
      artifact-name:
        description: Optional artifact name to upload.
        required: false
        type: string
        default: ''
      artifact-path:
        description: Optional artifact path(s) to upload.
        required: false
        type: string
        default: ''
      java-version:
        description: Java version for the build.
        required: false
        type: string
        default: '17'
      java-distribution:
        description: Java distribution for the build.
        required: false
        type: string
        default: 'temurin'
      ndk-version:
        description: Android NDK version to install.
        required: false
        type: string
        default: 'r26d'
      build-mnn-native:
        description: Build MNN native libraries from source for on-device LLM inference.
        required: false
        type: boolean
        default: true
      mnn-version:
        description: MNN git tag or branch to build from.
        required: false
        type: string
        default: '3.1.2'
    secrets:
      ANDROID_KEYSTORE_BASE64:
        required: false
      ANDROID_KEYSTORE_PASSWORD:
        required: false
      ANDROID_KEY_ALIAS:
        required: false
      ANDROID_KEY_PASSWORD:
        required: false
    outputs:
      version-name:
        description: App version name.
        value: ${{ jobs.android.outputs['version-name'] }}
      version-code:
        description: App version code.
        value: ${{ jobs.android.outputs['version-code'] }}

jobs:
  android:
    runs-on: ubuntu-latest
    env:
      ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
    outputs:
      version-name: ${{ steps.version.outputs['version-name'] }}
      version-code: ${{ steps.version.outputs['version-code'] }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ inputs['java-version'] }}
          distribution: ${{ inputs['java-distribution'] }}

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3
        with:
          cmdline-tools-version: 11076708

      - name: Install required Android SDK packages
        run: |
          yes | "$ANDROID_HOME"/cmdline-tools/latest/bin/sdkmanager --licenses || true
          "$ANDROID_HOME"/cmdline-tools/latest/bin/sdkmanager \
            "platforms;android-34" \
            "build-tools;34.0.0" \
            "platform-tools"

      - name: Set up Android NDK
        uses: nttld/setup-ndk@v1
        id: setup-ndk
        with:
          ndk-version: ${{ inputs['ndk-version'] }}
          link-to-sdk: true

      - name: Cache MNN native libraries
        if: inputs['build-mnn-native']
        id: cache-mnn
        uses: actions/cache@v4
        with:
          path: app/src/main/jniLibs
          key: mnn-native-${{ inputs['ndk-version'] }}-${{ inputs['mnn-version'] }}-arm64v8a

      - name: Build MNN native libraries from source
        if: inputs['build-mnn-native'] && steps.cache-mnn.outputs.cache-hit != 'true'
        env:
          ANDROID_NDK: ${{ steps.setup-ndk.outputs.ndk-path }}
        run: |
          set -euo pipefail

          echo "::group::Clone MNN ${{ inputs['mnn-version'] }}"
          git clone --depth 1 --branch "${{ inputs['mnn-version'] }}" \
            https://github.com/alibaba/MNN.git /tmp/MNN
          echo "::endgroup::"

          echo "::group::Configure CMake for arm64-v8a"
          mkdir -p /tmp/MNN/build-android
          cmake -S /tmp/MNN -B /tmp/MNN/build-android \
            -DCMAKE_TOOLCHAIN_FILE="$ANDROID_NDK/build/cmake/android.toolchain.cmake" \
            -DCMAKE_BUILD_TYPE=Release \
            -DANDROID_ABI=arm64-v8a \
            -DANDROID_STL=c++_static \
            -DANDROID_NATIVE_API_LEVEL=android-24 \
            -DMNN_BUILD_FOR_ANDROID_COMMAND=ON \
            -DMNN_BUILD_LLM=ON \
            -DMNN_BUILD_SHARED_LIBS=ON \
            -DMNN_ARM82=ON \
            -DMNN_USE_LOGCAT=OFF \
            -DMNN_OPENMP=OFF \
            -DMNN_USE_THREAD_POOL=ON \
            -DMNN_SEP_BUILD=ON
          echo "::endgroup::"

          echo "::group::Build MNN (arm64-v8a)"
          cmake --build /tmp/MNN/build-android -j "$(nproc)"
          echo "::endgroup::"

          echo "::group::Collect native libraries"
          mkdir -p app/src/main/jniLibs/arm64-v8a
          find /tmp/MNN/build-android -name 'libMNN.so'         -exec cp -v {} app/src/main/jniLibs/arm64-v8a/ \;
          find /tmp/MNN/build-android -name 'libMNN_Express.so'  -exec cp -v {} app/src/main/jniLibs/arm64-v8a/ \;
          find /tmp/MNN/build-android -name 'libmnnllm.so'       -exec cp -v {} app/src/main/jniLibs/arm64-v8a/ \;
          echo "--- Collected libraries ---"
          ls -lh app/src/main/jniLibs/arm64-v8a/
          echo "::endgroup::"

      - name: Set up Gradle cache
        uses: gradle/actions/setup-gradle@v4

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Decode Android signing keystore
        if: env.ANDROID_KEYSTORE_BASE64 != ''
        run: |
          echo "$ANDROID_KEYSTORE_BASE64" | base64 --decode > "$RUNNER_TEMP/release-keystore.jks"

      - name: Extract version information
        id: version
        run: |
          VERSION_NAME=$(sed -nE 's/^[[:space:]]*versionName[[:space:]]+"([^"]+)"/\1/p' app/build.gradle | head -n1)
          VERSION_CODE=$(sed -nE 's/^[[:space:]]*versionCode[[:space:]]+([0-9]+)/\1/p' app/build.gradle | head -n1)
          echo "version-name=${VERSION_NAME:-1.0}" >> "$GITHUB_OUTPUT"
          echo "version-code=${VERSION_CODE:-1}" >> "$GITHUB_OUTPUT"

      - name: Run Gradle task
        env:
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
          KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          if [[ -n "$ANDROID_KEYSTORE_BASE64" ]]; then
            export KEYSTORE_FILE="$RUNNER_TEMP/release-keystore.jks"
          else
            unset KEYSTORE_FILE
          fi
          ./gradlew ${{ inputs['gradle-task'] }} ${{ inputs['gradle-args'] }}

      - name: Upload artifact
        if: inputs['artifact-name'] != '' && inputs['artifact-path'] != ''
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs['artifact-name'] }}
          path: ${{ inputs['artifact-path'] }}
          if-no-files-found: error
