name: Deploy to Google Play

on:
  workflow_dispatch:
    inputs:
      release-status:
        description: Track to publish to on Google Play
        required: true
        default: internal
        type: choice
        options:
          - internal
          - alpha
          - beta
          - production
      whatsnew-dir:
        description: Optional folder containing localized release notes (metadata/android/*/changelogs)
        required: false
        default: ''
        type: string

permissions:
  contents: read

concurrency:
  group: google-play-${{ github.ref }}
  cancel-in-progress: false

jobs:
  deploy:
    name: Build and deploy AAB
    runs-on: ubuntu-latest

    steps:
      - name: Validate deployment secrets
        env:
          PLAY_CONFIG_JSON: ${{ secrets.PLAY_CONFIG_JSON }}
          PLAY_PACKAGE_NAME: ${{ secrets.PLAY_PACKAGE_NAME }}
        run: |
          if [[ -z "$PLAY_CONFIG_JSON" ]]; then
            echo "::error::PLAY_CONFIG_JSON secret is required."
            exit 1
          fi
          if [[ -z "$PLAY_PACKAGE_NAME" ]]; then
            echo "::error::PLAY_PACKAGE_NAME secret is required."
            exit 1
          fi

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: temurin

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3
        with:
          cmdline-tools-version: 11076708

      - name: Install required Android SDK packages
        run: |
          yes | "$ANDROID_HOME"/cmdline-tools/latest/bin/sdkmanager --licenses || true
          "$ANDROID_HOME"/cmdline-tools/latest/bin/sdkmanager \
            "platforms;android-34" \
            "build-tools;34.0.0" \
            "platform-tools"

      - name: Set up Gradle cache
        uses: gradle/actions/setup-gradle@v4

      - name: Prepare Android signing keystore
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          if [[ -z "$ANDROID_KEYSTORE_BASE64" ]]; then
            echo "::error::ANDROID_KEYSTORE_BASE64 secret is required for Play Store deployment."
            exit 1
          fi
          echo "$ANDROID_KEYSTORE_BASE64" | base64 --decode > "$RUNNER_TEMP/release-keystore.jks"

      - name: Build signed release bundle
        env:
          KEYSTORE_FILE: ${{ runner.temp }}/release-keystore.jks
          KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          chmod +x gradlew
          ./gradlew bundleRelease --stacktrace --warning-mode all

      - name: Publish to Google Play
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.PLAY_CONFIG_JSON }}
          packageName: ${{ secrets.PLAY_PACKAGE_NAME }}
          releaseFiles: app/build/outputs/bundle/release/*.aab
          track: ${{ inputs['release-status'] }}
          status: completed
          whatsNewDirectory: ${{ inputs['whatsnew-dir'] }}
