name: Main CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ !startsWith(github.ref, 'refs/tags/') }}

env:
  JAVA_VERSION: '17'
  JAVA_DISTRIBUTION: 'temurin'

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: ${{ env.JAVA_DISTRIBUTION }}

    - name: Set up Android SDK
      uses: android-actions/setup-android@v3
      with:
        cmdline-tools-version: 11076708

    - name: Install required Android SDK packages
      run: |
        yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || true
        $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "platforms;android-34" "build-tools;33.0.2" "platform-tools"
        echo "Installed SDK packages:"
        $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --list_installed

    - name: Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Compile project
      id: compile
      run: |
        ./gradlew compileDebugSources --continue --stacktrace --warning-mode all 2>&1 | tee compile_output.txt
        exit_code=${PIPESTATUS[0]}

        if [ $exit_code -ne 0 ]; then
          echo ""
          echo "::group::Compilation Errors (last 200 lines)"
          tail -200 compile_output.txt
          echo "::endgroup::"

          echo ""
          echo "::group::Error Summary"
          grep -E "^e: |error:|Error:|FAILURE:|BUILD FAILED" compile_output.txt || echo "No specific error pattern found - check full output above"
          echo "::endgroup::"
        fi

        exit $exit_code
      continue-on-error: true

    - name: Report compilation results
      if: always()
      run: |
        if [ "${{ steps.compile.outcome }}" == "failure" ]; then
          echo "::error::Compilation failed. Check the 'Compilation Errors' section above for details."
        else
          echo "::notice::Compilation succeeded!"
        fi

    - name: Upload compilation log on failure
      if: steps.compile.outcome == 'failure'
      uses: actions/upload-artifact@v4
      with:
        name: compile-error-log
        path: compile_output.txt
        if-no-files-found: ignore

    - name: Run unit tests
      if: steps.compile.outcome == 'success'
      run: ./gradlew testDebugUnitTest --continue
      continue-on-error: true
      id: unit-tests

    - name: Run lint checks
      if: steps.compile.outcome == 'success'
      run: ./gradlew lintDebug --continue
      continue-on-error: true
      id: lint-checks

    - name: Report test and lint results
      if: always()
      run: |
        if [ "${{ steps.unit-tests.outcome }}" == "failure" ]; then
          echo "::error::Unit tests failed. Check test reports for details."
        fi
        if [ "${{ steps.lint-checks.outcome }}" == "failure" ]; then
          echo "::warning::Lint checks found issues. Check lint reports for details."
        fi

    - name: Fail workflow if compilation or tests failed
      if: always()
      run: |
        if [ "${{ steps.compile.outcome }}" == "failure" ] || [ "${{ steps.unit-tests.outcome }}" == "failure" ]; then
          echo "Workflow failed due to compilation or test failures"
          exit 1
        fi

    - name: Upload test reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-reports
        path: |
          app/build/reports/tests/
          app/build/reports/lint-results-debug.html

  build:
    name: Build APK
    runs-on: ubuntu-latest
    needs: test
    if: needs.test.result == 'success'
    permissions:
      contents: read

    outputs:
      version-name: ${{ steps.version.outputs.version-name }}
      version-code: ${{ steps.version.outputs.version-code }}
      build-success: ${{ steps.build-debug.outcome == 'success' }}
      release-signed: ${{ steps.sign_apk.outputs.signed || 'false' }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: ${{ env.JAVA_DISTRIBUTION }}

    - name: Set up Android SDK
      uses: android-actions/setup-android@v3
      with:
        cmdline-tools-version: 11076708

    - name: Install required Android SDK packages
      run: |
        yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || true
        $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "platforms;android-34" "build-tools;33.0.2" "platform-tools"
        echo "Installed SDK packages:"
        $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --list_installed

    - name: Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Extract version information
      id: version
      run: |
        VERSION_NAME=$(./gradlew -q printVersionName 2>/dev/null | tail -n1 || echo "1.0")
        VERSION_CODE=$(./gradlew -q printVersionCode 2>/dev/null | tail -n1 || echo "1")
        echo "version-name=$VERSION_NAME" >> $GITHUB_OUTPUT
        echo "version-code=$VERSION_CODE" >> $GITHUB_OUTPUT
        echo "Version Name: $VERSION_NAME"
        echo "Version Code: $VERSION_CODE"
      continue-on-error: true

    - name: Build debug APK
      id: build-debug
      run: |
        echo "Building debug APK..."
        ./gradlew assembleDebug --continue --stacktrace --warning-mode all 2>&1 | tee build_output.txt
        exit_code=${PIPESTATUS[0]}

        if [ $exit_code -ne 0 ]; then
          echo ""
          echo "::group::Build Errors (last 200 lines)"
          tail -200 build_output.txt
          echo "::endgroup::"

          echo ""
          echo "::group::Error Summary"
          grep -E "^e: |error:|Error:|FAILURE:|BUILD FAILED" build_output.txt || echo "No specific error pattern found - check full output above"
          echo "::endgroup::"
        fi

        exit $exit_code
      continue-on-error: true

    - name: Report build status
      if: always()
      run: |
        if [ "${{ steps.build-debug.outcome }}" == "failure" ]; then
          echo "::error::Debug APK build failed. Check the 'Build Errors' section above for details."
        else
          echo "::notice::Debug APK built successfully!"
        fi

    - name: Upload build log on failure
      if: steps.build-debug.outcome == 'failure'
      uses: actions/upload-artifact@v4
      with:
        name: build-error-log
        path: build_output.txt
        if-no-files-found: ignore

    - name: Build release APK (unsigned)
      if: steps.build-debug.outcome == 'success'
      run: ./gradlew assembleRelease --continue
      continue-on-error: true

    - name: Sign release APK
      id: sign_apk
      if: steps.build-debug.outcome == 'success' && github.event_name == 'push' && (startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/main')
      env:
        KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
        KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
      run: |
        if [[ -n "$KEYSTORE_PASSWORD" && -n "$KEY_ALIAS" && -n "$KEY_PASSWORD" ]]; then
          echo "Signing APK with keystore..."
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > release-keystore.jks

          jarsigner -verbose -sigalg SHA256withRSA -digestalg SHA-256 \
            -keystore release-keystore.jks \
            -storepass "$KEYSTORE_PASSWORD" \
            -keypass "$KEY_PASSWORD" \
            app/build/outputs/apk/release/app-release-unsigned.apk \
            "$KEY_ALIAS"

          $ANDROID_HOME/build-tools/33.0.2/zipalign -v 4 \
            app/build/outputs/apk/release/app-release-unsigned.apk \
            app/build/outputs/apk/release/TronProtocol-release-signed.apk

          echo "signed=true" >> $GITHUB_OUTPUT
          echo "APK signed successfully"
        else
          echo "Keystore secrets not available, using unsigned APK"
          if [[ -f "app/build/outputs/apk/release/app-release-unsigned.apk" ]]; then
            cp app/build/outputs/apk/release/app-release-unsigned.apk \
               app/build/outputs/apk/release/TronProtocol-release-signed.apk
          fi
          echo "signed=false" >> $GITHUB_OUTPUT
        fi
      continue-on-error: true

    - name: Rename APK files
      if: steps.build-debug.outcome == 'success'
      run: |
        VERSION_NAME="${{ steps.version.outputs.version-name }}"

        if [[ -f "app/build/outputs/apk/debug/app-debug.apk" ]]; then
          mv app/build/outputs/apk/debug/app-debug.apk \
             app/build/outputs/apk/debug/TronProtocol-v${VERSION_NAME}-debug.apk
        fi

        if [[ -f "app/build/outputs/apk/release/TronProtocol-release-signed.apk" ]]; then
          mv app/build/outputs/apk/release/TronProtocol-release-signed.apk \
             app/build/outputs/apk/release/TronProtocol-v${VERSION_NAME}-release.apk
        elif [[ -f "app/build/outputs/apk/release/app-release-unsigned.apk" ]]; then
          mv app/build/outputs/apk/release/app-release-unsigned.apk \
             app/build/outputs/apk/release/TronProtocol-v${VERSION_NAME}-release-unsigned.apk
        fi

    - name: Generate checksums
      if: steps.build-debug.outcome == 'success'
      run: |
        VERSION_NAME="${{ steps.version.outputs.version-name }}"
        cd app/build/outputs/apk

        if [[ -f "debug/TronProtocol-v${VERSION_NAME}-debug.apk" ]]; then
          sha256sum debug/TronProtocol-v${VERSION_NAME}-debug.apk > debug/TronProtocol-v${VERSION_NAME}-debug.apk.sha256
        fi

        if [[ -f "release/TronProtocol-v${VERSION_NAME}-release.apk" ]]; then
          sha256sum release/TronProtocol-v${VERSION_NAME}-release.apk > release/TronProtocol-v${VERSION_NAME}-release.apk.sha256
        elif [[ -f "release/TronProtocol-v${VERSION_NAME}-release-unsigned.apk" ]]; then
          sha256sum release/TronProtocol-v${VERSION_NAME}-release-unsigned.apk > release/TronProtocol-v${VERSION_NAME}-release-unsigned.apk.sha256
        fi

        echo "=== APK Checksums ==="
        cat debug/*.sha256 2>/dev/null || true
        cat release/*.sha256 2>/dev/null || true

    - name: Upload debug APK
      if: steps.build-debug.outcome == 'success'
      uses: actions/upload-artifact@v4
      with:
        name: debug-apk
        path: |
          app/build/outputs/apk/debug/TronProtocol-v${{ steps.version.outputs.version-name }}-debug.apk
          app/build/outputs/apk/debug/*.sha256

    - name: Upload release APK
      if: steps.build-debug.outcome == 'success'
      uses: actions/upload-artifact@v4
      with:
        name: release-apk
        path: |
          app/build/outputs/apk/release/TronProtocol-v${{ steps.version.outputs.version-name }}-release*.apk
          app/build/outputs/apk/release/*.sha256

  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: build
    if: needs.build.outputs.build-success == 'true' && needs.build.outputs.release-signed == 'true' && github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') && startsWith(github.ref_name, 'v')
    permissions:
      contents: write
    environment:
      name: release

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Validate semantic version tag
      run: |
        TAG_NAME="${GITHUB_REF#refs/tags/}"
        SEMVER_REGEX='^v([0-9]+)\.([0-9]+)\.([0-9]+)(-([0-9A-Za-z-]+(\.[0-9A-Za-z-]+)*))?(\+([0-9A-Za-z-]+(\.[0-9A-Za-z-]+)*))?$'

        if [[ ! "$TAG_NAME" =~ $SEMVER_REGEX ]]; then
          echo "::error::Tag '$TAG_NAME' is not a semantic version tag (expected vMAJOR.MINOR.PATCH[-PRERELEASE][+BUILD])."
          exit 1
        fi

    - name: Ensure signing and release secrets are available
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        if [[ -z "${GITHUB_TOKEN}" ]]; then
          echo "::error::Release requires protected environment secrets; GITHUB_TOKEN is unavailable."
          exit 1
        fi

    - name: Download all APKs
      uses: actions/download-artifact@v4
      with:
        path: apks

    - name: Generate release notes
      id: release_notes
      run: |
        VERSION="${{ needs.build.outputs.version-name }}"
        TAG_NAME="${GITHUB_REF#refs/tags/}"

        PREVIOUS_TAG=$(git describe --abbrev=0 --tags "${TAG_NAME}^" 2>/dev/null || echo "")
        if [ -n "$PREVIOUS_TAG" ]; then
          COMMITS=$(git log "${PREVIOUS_TAG}..${TAG_NAME}" --pretty=format:"- %s" --no-merges)
        else
          COMMITS=$(git log "${TAG_NAME}" --pretty=format:"- %s" --no-merges --max-count=20)
        fi

        DEBUG_CHECKSUM=""
        RELEASE_CHECKSUM=""

        if [[ -f "apks/debug-apk/TronProtocol-v${VERSION}-debug.apk.sha256" ]]; then
          DEBUG_CHECKSUM=$(cat "apks/debug-apk/TronProtocol-v${VERSION}-debug.apk.sha256" 2>/dev/null || echo "N/A")
        fi

        if [[ -f "apks/release-apk/TronProtocol-v${VERSION}-release.apk.sha256" ]]; then
          RELEASE_CHECKSUM=$(cat "apks/release-apk/TronProtocol-v${VERSION}-release.apk.sha256" 2>/dev/null || echo "N/A")
        elif [[ -f "apks/release-apk/TronProtocol-v${VERSION}-release-unsigned.apk.sha256" ]]; then
          RELEASE_CHECKSUM=$(cat "apks/release-apk/TronProtocol-v${VERSION}-release-unsigned.apk.sha256" 2>/dev/null || echo "N/A")
        fi

        cat > release_notes.md << EOF
        ## TronProtocol ${VERSION}

        ### Changes in this Release
        ${COMMITS}

        ### Checksums (SHA256)

        **Release APK:**
        \`\`\`
        ${RELEASE_CHECKSUM}
        \`\`\`

        **Debug APK:**
        \`\`\`
        ${DEBUG_CHECKSUM}
        \`\`\`
        EOF

        echo "release_body<<EOF" >> $GITHUB_OUTPUT
        cat release_notes.md >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Create Release and Upload Assets
      uses: softprops/action-gh-release@v2
      with:
        name: TronProtocol ${{ needs.build.outputs.version-name }}
        body: ${{ steps.release_notes.outputs.release_body }}
        draft: false
        prerelease: false
        files: |
          ./apks/release-apk/TronProtocol-v${{ needs.build.outputs.version-name }}-release.apk
          ./apks/release-apk/TronProtocol-v${{ needs.build.outputs.version-name }}-release-unsigned.apk
          ./apks/debug-apk/TronProtocol-v${{ needs.build.outputs.version-name }}-debug.apk
          ./apks/release-apk/*.sha256
          ./apks/debug-apk/*.sha256
        fail_on_unmatched_files: false
